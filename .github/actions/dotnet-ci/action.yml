name: Dotnet CI
description: Restore, build, and test (with TRX + coverage) for this repo.

inputs:
  dotnet-version:
    description: .NET SDK version to install (e.g., 8.0.x)
    required: true
  solution-path:
    description: Path to the solution file
    required: true
  test-project-path:
    description: Path to the xUnit test project
    required: true
  configuration:
    description: Build configuration
    required: false
    default: Release
  test-filter:
    description: Optional dotnet test --filter expression
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Cache NuGet
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln', '**/*.csproj', '**/Directory.Packages.props') }}
        restore-keys: |
          nuget-${{ runner.os }}-

    - name: Restore
      shell: pwsh
      run: |
        dotnet restore "${{ inputs.solution-path }}"

    - name: Build
      shell: pwsh
      run: |
        dotnet build "${{ inputs.solution-path }}" -c "${{ inputs.configuration }}" --no-restore

    - name: Test (TRX + Coverage)
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "TestResults" | Out-Null

        $filter = "${{ inputs.test-filter }}".Trim()
        $filterArg = @()
        if ($filter.Length -gt 0) {
          $filterArg = @("--filter", $filter)
        }

        dotnet test "${{ inputs.test-project-path }}" `
          -c "${{ inputs.configuration }}" `
          --no-build `
          --results-directory "TestResults" `
          --logger "trx;LogFileName=test-results.trx" `
          --collect "XPlat Code Coverage" `
          @filterArg

